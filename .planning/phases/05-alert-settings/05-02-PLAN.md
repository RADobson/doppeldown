---
phase: 05-alert-settings
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/dashboard/settings/page.tsx
  - src/app/api/cron/digest/route.ts
  - vercel.json
autonomous: true

must_haves:
  truths:
    - "User can set severity threshold via radio buttons (all/high+critical/critical)"
    - "User can toggle scan summary emails on/off"
    - "User can toggle weekly digest on/off"
    - "Settings persist when saved"
    - "Weekly digest cron runs every Monday at 9am UTC"
  artifacts:
    - path: "src/app/dashboard/settings/page.tsx"
      provides: "Updated settings UI with severity radio, scan summary toggle, weekly digest toggle"
      contains: "severity_threshold"
    - path: "src/app/api/cron/digest/route.ts"
      provides: "Weekly digest cron endpoint"
      exports: ["GET"]
    - path: "vercel.json"
      provides: "Cron schedule for weekly digest"
      contains: "/api/cron/digest"
  key_links:
    - from: "src/app/dashboard/settings/page.tsx"
      to: "alert_settings table"
      via: "supabase upsert on save"
      pattern: "severity_threshold.*scan_summary_emails.*weekly_digest"
    - from: "src/app/api/cron/digest/route.ts"
      to: "src/lib/email.ts"
      via: "import sendWeeklyDigest"
      pattern: "sendWeeklyDigest"
---

<objective>
Update settings UI with new alert preferences and create weekly digest cron endpoint.

Purpose: User-facing controls for alert preferences and scheduled weekly digest delivery.
Output: Enhanced settings page, digest cron endpoint, updated vercel.json.
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-alert-settings/05-RESEARCH.md
@.planning/phases/05-alert-settings/05-CONTEXT.md
@.planning/phases/05-alert-settings/05-01-SUMMARY.md
@src/app/dashboard/settings/page.tsx
@src/app/api/cron/scan/route.ts
@vercel.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update settings page with new alert preference controls</name>
  <files>src/app/dashboard/settings/page.tsx</files>
  <action>
Modify the Alert Preferences section to include new controls:

1. Update AlertSettings interface in component (around line 21-29):
   - Add severity_threshold: 'all' | 'high_critical' | 'critical'
   - Add scan_summary_emails: boolean
   - Add weekly_digest: boolean
   - Keep existing fields for backward compat

2. Update initial state (around line 49-57):
   - severity_threshold: 'high_critical' (default)
   - scan_summary_emails: true (default)
   - weekly_digest: true (default)

3. Update fetchData to read new fields from database (around line 107-120):
   - Map severity_threshold from DB (or derive from alert_on_severity if null)
   - Read scan_summary_emails (default true if null)
   - Read weekly_digest (default true if null, fallback to daily_digest value)

4. Replace "Alert on Severity" chip buttons (lines 418-439) with radio button group:
```tsx
<div>
  <p className="font-medium text-gray-900 mb-2">Alert Severity Threshold</p>
  <p className="text-sm text-gray-500 mb-3">Which threats should trigger email alerts?</p>
  <div className="space-y-2">
    {[
      { value: 'all', label: 'All Threats', desc: 'Low, Medium, High, and Critical' },
      { value: 'high_critical', label: 'High + Critical Only', desc: 'Skip low and medium severity' },
      { value: 'critical', label: 'Critical Only', desc: 'Only the most severe threats' },
    ].map((option) => (
      <label key={option.value} className="flex items-start gap-3 cursor-pointer">
        <input
          type="radio"
          name="severity_threshold"
          value={option.value}
          checked={alertSettings.severity_threshold === option.value}
          onChange={(e) => setAlertSettings({
            ...alertSettings,
            severity_threshold: e.target.value as 'all' | 'high_critical' | 'critical'
          })}
          className="mt-1 h-4 w-4 text-primary-600 focus:ring-primary-500"
        />
        <div>
          <span className="font-medium text-gray-900">{option.label}</span>
          <p className="text-sm text-gray-500">{option.desc}</p>
        </div>
      </label>
    ))}
  </div>
</div>
```

5. Add Scan Summary toggle (after Email Alerts toggle):
```tsx
<div className="flex items-center justify-between">
  <div>
    <p className="font-medium text-gray-900">Scan Summary Emails</p>
    <p className="text-sm text-gray-500">Receive summary after each scan completes</p>
  </div>
  <button
    onClick={() => setAlertSettings({ ...alertSettings, scan_summary_emails: !alertSettings.scan_summary_emails })}
    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
      alertSettings.scan_summary_emails ? 'bg-primary-600' : 'bg-gray-200'
    }`}
  >
    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
      alertSettings.scan_summary_emails ? 'translate-x-6' : 'translate-x-1'
    }`} />
  </button>
</div>
```

6. Rename "Daily Digest" to "Weekly Digest" (around line 389-405):
   - Change label from "Daily Digest" to "Weekly Digest"
   - Change description to "Receive a weekly summary every Monday"
   - Change state key from daily_digest to weekly_digest

7. Update handleSaveAlerts to save new fields (around line 152-182):
   - Include severity_threshold in upsert
   - Include scan_summary_emails in upsert
   - Include weekly_digest in upsert
   - Keep daily_digest for backward compat (set to same value as weekly_digest)
  </action>
  <verify>Run: grep -E "severity_threshold|scan_summary_emails|weekly_digest" src/app/dashboard/settings/page.tsx | head -10</verify>
  <done>Settings page shows severity radio buttons, scan summary toggle, weekly digest toggle, and saves all fields correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create weekly digest cron endpoint and update vercel.json</name>
  <files>
    src/app/api/cron/digest/route.ts
    vercel.json
  </files>
  <action>
1. Create /api/cron/digest/route.ts following existing /api/cron/scan pattern:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createServiceClient } from '@/lib/supabase/server'
import { sendWeeklyDigest } from '@/lib/email'
import { subDays } from 'date-fns'

export async function GET(request: NextRequest) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const supabase = await createServiceClient()
    const weekAgo = subDays(new Date(), 7).toISOString()

    // Get users with weekly digest enabled
    const { data: settings, error: settingsError } = await supabase
      .from('alert_settings')
      .select('user_id, alert_email')
      .eq('email_alerts', true)
      .or('weekly_digest.eq.true,daily_digest.eq.true')  // Support both for transition

    if (settingsError) throw settingsError

    const results = { sent: 0, skipped: 0, errors: [] as string[] }

    for (const setting of settings || []) {
      try {
        // Get user email fallback
        const { data: user } = await supabase
          .from('users')
          .select('email')
          .eq('id', setting.user_id)
          .single()

        const email = setting.alert_email || user?.email
        if (!email) {
          results.skipped++
          continue
        }

        // Get user's brands
        const { data: brands } = await supabase
          .from('brands')
          .select('*')
          .eq('user_id', setting.user_id)

        if (!brands?.length) {
          results.skipped++
          continue
        }

        // Get threats from past week for each brand
        const brandSummaries = []
        for (const brand of brands) {
          const { data: threats, count } = await supabase
            .from('threats')
            .select('*', { count: 'exact' })
            .eq('brand_id', brand.id)
            .gte('detected_at', weekAgo)
            .order('detected_at', { ascending: false })
            .limit(10)  // Limit to avoid Gmail clipping

          if (count && count > 0) {
            brandSummaries.push({ brand, newThreats: count, threats: threats || [] })
          }
        }

        // Send digest if there's anything to report
        if (brandSummaries.length > 0) {
          await sendWeeklyDigest(email, brandSummaries)
          results.sent++
        } else {
          results.skipped++
        }
      } catch (userError) {
        const msg = userError instanceof Error ? userError.message : 'Unknown'
        results.errors.push(`User ${setting.user_id}: ${msg}`)
      }
    }

    return NextResponse.json({
      success: true,
      results,
      timestamp: new Date().toISOString()
    })
  } catch (error) {
    console.error('Weekly digest cron error:', error)
    return NextResponse.json({ error: 'Digest cron failed' }, { status: 500 })
  }
}
```

2. Update vercel.json to add weekly digest cron:
   - Add entry for "/api/cron/digest" with schedule "0 9 * * 1" (Monday 9am UTC)
   - Keep existing scan cron unchanged

Final vercel.json should have:
```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "crons": [
    { "path": "/api/cron/scan", "schedule": "0 * * * *" },
    { "path": "/api/cron/digest", "schedule": "0 9 * * 1" }
  ]
}
```
  </action>
  <verify>Run: cat vercel.json && test -f src/app/api/cron/digest/route.ts && echo "Digest endpoint exists"</verify>
  <done>Weekly digest cron endpoint exists at /api/cron/digest, vercel.json includes Monday 9am UTC schedule</done>
</task>

</tasks>

<verification>
- [ ] Settings page compiles: `npx tsc --noEmit src/app/dashboard/settings/page.tsx`
- [ ] Cron endpoint compiles: `npx tsc --noEmit src/app/api/cron/digest/route.ts`
- [ ] vercel.json is valid JSON: `cat vercel.json | jq .`
- [ ] All new fields in settings page: `grep -c "severity_threshold\|scan_summary_emails\|weekly_digest" src/app/dashboard/settings/page.tsx`
</verification>

<success_criteria>
1. Settings page has radio buttons for severity threshold (3 options)
2. Settings page has toggle for scan summary emails
3. Settings page shows "Weekly Digest" (renamed from Daily)
4. All preferences save to database correctly
5. /api/cron/digest endpoint exists and is secured with CRON_SECRET
6. vercel.json schedules digest for Monday 9am UTC
</success_criteria>

<output>
After completion, create `.planning/phases/05-alert-settings/05-02-SUMMARY.md`
</output>
