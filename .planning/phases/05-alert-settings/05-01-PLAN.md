---
phase: 05-alert-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260127300001_add_alert_preferences.sql
  - src/types/index.ts
  - src/lib/email.ts
autonomous: true

must_haves:
  truths:
    - "Alert settings table has severity_threshold, scan_summary_emails, weekly_digest columns"
    - "AlertSettings TypeScript interface matches database schema"
    - "sendScanSummary and sendWeeklyDigest email functions exist"
  artifacts:
    - path: "supabase/migrations/20260127300001_add_alert_preferences.sql"
      provides: "New columns for alert preferences"
      contains: "severity_threshold"
    - path: "src/types/index.ts"
      provides: "Updated AlertSettings interface"
      contains: "severity_threshold"
    - path: "src/lib/email.ts"
      provides: "Scan summary and weekly digest email functions"
      exports: ["sendScanSummary", "sendWeeklyDigest"]
  key_links:
    - from: "src/types/index.ts"
      to: "alert_settings table"
      via: "TypeScript interface mirrors DB columns"
      pattern: "severity_threshold.*scan_summary_emails.*weekly_digest"
---

<objective>
Add database columns, TypeScript types, and email functions for enhanced alert preferences.

Purpose: Foundation layer enabling severity threshold, scan summary emails, and weekly digest features.
Output: Migration file, updated types, new email template functions.
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-alert-settings/05-RESEARCH.md
@.planning/phases/05-alert-settings/05-CONTEXT.md
@src/lib/email.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alert preferences columns to database</name>
  <files>supabase/migrations/20260127300001_add_alert_preferences.sql</files>
  <action>
Create migration to extend alert_settings table:

1. Add severity_threshold column:
   - Type: TEXT with CHECK constraint ('all', 'high_critical', 'critical')
   - Default: 'high_critical' (matches current behavior of alert_on_severity defaulting to ['critical', 'high'])

2. Add scan_summary_emails column:
   - Type: BOOLEAN, default TRUE
   - Purpose: Toggle scan completion summary emails

3. Add weekly_digest column:
   - Type: BOOLEAN, default TRUE
   - Note: Keep existing daily_digest column for backward compat (mark deprecated in comment)

4. Add comments explaining each column's purpose

Do NOT drop or rename existing columns - additive only for safety.
  </action>
  <verify>Run: cat supabase/migrations/20260127300001_add_alert_preferences.sql | grep -E "severity_threshold|scan_summary_emails|weekly_digest"</verify>
  <done>Migration file exists with all three new columns, proper defaults, and CHECK constraint on severity_threshold</done>
</task>

<task type="auto">
  <name>Task 2: Update AlertSettings TypeScript interface</name>
  <files>src/types/index.ts</files>
  <action>
Update the AlertSettings interface (around line 219) to include new fields:

```typescript
export interface AlertSettings {
  email_alerts: boolean;
  alert_email: string;
  alert_on_severity: ThreatSeverity[];  // Keep for backward compat
  severity_threshold: 'all' | 'high_critical' | 'critical';  // NEW: simplified threshold
  scan_summary_emails: boolean;  // NEW: per-scan summary toggle
  daily_digest: boolean;  // DEPRECATED: use weekly_digest
  weekly_digest: boolean;  // NEW: weekly digest toggle
  instant_critical: boolean;
}
```

Add JSDoc comments explaining:
- severity_threshold replaces alert_on_severity for new UI
- weekly_digest is the canonical field (daily_digest kept for migration)
  </action>
  <verify>Run: grep -A 12 "export interface AlertSettings" src/types/index.ts</verify>
  <done>AlertSettings interface has severity_threshold, scan_summary_emails, and weekly_digest fields with proper types</done>
</task>

<task type="auto">
  <name>Task 3: Add scan summary and weekly digest email functions</name>
  <files>src/lib/email.ts</files>
  <action>
Add two new exported functions following existing template patterns:

1. sendScanSummary(to, brand, scanResult):
   - Parameters: to (string), brand (Brand), scanResult ({ domainsChecked, threatsFound, threats: Threat[] })
   - Subject format: "Scan Complete: {brand.name} - {N} threats found"
   - Template: Stats boxes (domains checked, threats found), top 5 threats with severity badges, CTA to dashboard
   - Use existing header style (blue gradient, DoppelDown branding)
   - Keep under 50KB to avoid Gmail clipping

2. sendWeeklyDigest(to, brandSummaries):
   - Parameters: to (string), brandSummaries ({ brand: Brand, newThreats: number, threats: Threat[] }[])
   - Subject format: "Weekly Security Digest - {N} new threats"
   - Template: Stats (brands monitored, total new threats), per-brand breakdown with threat counts, CTA to dashboard
   - Limit to top 10 threats per brand (avoid Gmail 102KB clip)

Both functions:
- Use existing transporter
- Follow existing HTML/CSS patterns (table layout, inline styles)
- Include footer with settings link
- Use date-fns format() for dates
  </action>
  <verify>Run: grep -E "export async function send(ScanSummary|WeeklyDigest)" src/lib/email.ts</verify>
  <done>email.ts exports sendScanSummary and sendWeeklyDigest functions with proper signatures and HTML templates</done>
</task>

</tasks>

<verification>
- [ ] Migration file exists with valid SQL
- [ ] TypeScript compiles: `npx tsc --noEmit src/types/index.ts`
- [ ] email.ts exports visible: `grep "export async function" src/lib/email.ts`
</verification>

<success_criteria>
1. Migration adds severity_threshold, scan_summary_emails, weekly_digest columns
2. AlertSettings interface updated with new typed fields
3. sendScanSummary and sendWeeklyDigest functions exist and follow existing patterns
4. No TypeScript errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/05-alert-settings/05-01-SUMMARY.md`
</output>
