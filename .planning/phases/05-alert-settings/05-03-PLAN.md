---
phase: 05-alert-settings
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/scan-runner.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Scan summary email sent when scan_summary_emails preference is true"
    - "Severity threshold setting filters which threats trigger alerts"
  artifacts:
    - path: "src/lib/scan-runner.ts"
      provides: "Wired sendScanSummary call and severity_threshold reading"
      contains: "sendScanSummary"
  key_links:
    - from: "src/lib/scan-runner.ts"
      to: "sendScanSummary"
      via: "import and function call after scan completion"
      pattern: "sendScanSummary\\(alertEmail"
    - from: "src/lib/scan-runner.ts"
      to: "alertSettings.severity_threshold"
      via: "threshold to severity array conversion"
      pattern: "severity_threshold"
---

<objective>
Wire sendScanSummary email function and severity_threshold reading in scan-runner.ts

Purpose: Fix two verification gaps blocking ALRT-02 and ALRT-03 requirements
Output: scan-runner.ts properly calls sendScanSummary after scans and uses severity_threshold for alert filtering
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-alert-settings/05-VERIFICATION.md
@src/lib/scan-runner.ts
@src/lib/email.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire sendScanSummary and fix severity_threshold</name>
  <files>src/lib/scan-runner.ts</files>
  <action>
    1. Add sendScanSummary to the import from './email' (line 6):
       `import { sendThreatAlert, sendScanSummary } from './email'`

    2. Replace severity handling around line 879. Change:
       ```
       const alertSeverities = alertSettings?.alert_on_severity || ['critical', 'high']
       ```
       To:
       ```
       // Convert severity_threshold to severity array
       const thresholdToSeverities: Record<string, string[]> = {
         'critical': ['critical'],
         'high_critical': ['critical', 'high'],
         'all': ['critical', 'high', 'medium', 'low']
       }
       const alertSeverities = thresholdToSeverities[alertSettings?.severity_threshold || 'high_critical']
         || alertSettings?.alert_on_severity
         || ['critical', 'high']
       ```

    3. After the webhook block (around line 905), add scan summary email logic:
       ```
       // Send scan summary email if enabled
       if (alertSettings?.scan_summary_emails !== false) {
         try {
           await sendScanSummary(alertEmail, brand, {
             domainsChecked,
             threatsFound,
             threats: threats as Threat[]
           })
         } catch (summaryError) {
           console.error(`Failed to send scan summary for brand ${brand.id}:`, summaryError)
         }
       }
       ```

    Note: The scan summary is sent regardless of whether threats were found (user may want "all clear" confirmation). The threshold conversion falls back to alert_on_severity for backward compatibility.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.
    Grep for sendScanSummary import: `grep -n "sendScanSummary" src/lib/scan-runner.ts`
    Grep for severity_threshold usage: `grep -n "severity_threshold" src/lib/scan-runner.ts`
  </verify>
  <done>
    1. sendScanSummary imported and called after scan completion when scan_summary_emails is true
    2. severity_threshold read and converted to severity array for alert filtering
    3. Backward compatibility preserved via fallback to alert_on_severity
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors in scan-runner.ts
2. `grep -n "sendScanSummary" src/lib/scan-runner.ts` shows import and call site
3. `grep -n "severity_threshold" src/lib/scan-runner.ts` shows threshold conversion logic
</verification>

<success_criteria>
- sendScanSummary is imported from './email'
- sendScanSummary is called after scan completion when scan_summary_emails preference is true/undefined
- severity_threshold is read from alertSettings and converted to severity array
- Fallback to alert_on_severity maintains backward compatibility
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-alert-settings/05-03-SUMMARY.md`
</output>
