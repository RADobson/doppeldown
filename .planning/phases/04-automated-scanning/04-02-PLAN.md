---
phase: 04-automated-scanning
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/api/cron/scan/route.ts
  - vercel.json
autonomous: true

must_haves:
  truths:
    - "Cron runs hourly (0 * * * *)"
    - "Free tier brands never queued for auto-scan"
    - "Starter brands scan when 24+ hours since last scan"
    - "Professional brands scan when 6+ hours since last scan"
    - "Enterprise brands scan when 1+ hours since last scan"
    - "Paused brands (auto_scan_enabled=false) are skipped"
    - "Scan jobs have jitter (0-5 min) on scheduled_at"
  artifacts:
    - path: "src/app/api/cron/scan/route.ts"
      provides: "Hours-based scheduling with jitter"
      contains: "scanFrequencyHours"
    - path: "vercel.json"
      provides: "Hourly cron schedule"
      contains: "0 * * * *"
  key_links:
    - from: "src/app/api/cron/scan/route.ts"
      to: "src/lib/tier-limits.ts"
      via: "getScanFrequencyHours import"
      pattern: "getScanFrequencyHours|scanFrequencyHours"
    - from: "src/app/api/cron/scan/route.ts"
      to: "brands.auto_scan_enabled"
      via: "query filter"
      pattern: "auto_scan_enabled.*true"
    - from: "src/app/api/cron/scan/route.ts"
      to: "crypto.randomInt"
      via: "jitter calculation"
      pattern: "randomInt"
---

<objective>
Update cron endpoint to use hours-based scheduling with jitter and auto_scan_enabled filtering.

Purpose: Enable tier-appropriate automated scanning (hourly Enterprise, 6hr Pro, daily Starter, none Free).
Output: Updated cron route with hourly execution, hours-based tier filtering, jitter, and pause support.
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-automated-scanning/04-CONTEXT.md
@.planning/phases/04-automated-scanning/04-RESEARCH.md
@.planning/phases/04-automated-scanning/04-01-SUMMARY.md
@src/app/api/cron/scan/route.ts
@src/lib/tier-limits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update cron endpoint for hours-based scheduling</name>
  <files>src/app/api/cron/scan/route.ts</files>
  <action>
1. Import `randomInt` from 'crypto' and `getScanFrequencyHours` from tier-limits
2. Add `.eq('auto_scan_enabled', true)` to brands query filter
3. Replace days-based logic with hours-based:
   - Use `getScanFrequencyHours(effectiveTier)` instead of scanFrequencyDays
   - If null, skip (manual only) - existing behavior
   - Calculate `hoursSinceLastScan` using hours division
   - Compare against scanFrequencyHours threshold
4. Add jitter to scheduled_at:
   - `const jitterMs = randomInt(0, 5 * 60 * 1000)` (0-5 minutes)
   - `scheduled_at: new Date(Date.now() + jitterMs).toISOString()`
5. Remove or comment out scanFrequencyDays references (use Hours now)

Key changes:
- Line ~29: Add `.eq('auto_scan_enabled', true)` to query
- Line ~47: Use scanFrequencyHours instead of scanFrequencyDays
- Line ~57: Calculate hours not days: `/ (1000 * 60 * 60)` not `/ (1000 * 60 * 60 * 24)`
- Line ~109: Add jitter to scheduled_at timestamp
  </action>
  <verify>grep -E "(scanFrequencyHours|auto_scan_enabled|randomInt|jitterMs)" src/app/api/cron/scan/route.ts shows all 4 patterns</verify>
  <done>Cron uses hours-based scheduling, filters paused brands, adds jitter</done>
</task>

<task type="auto">
  <name>Task 2: Update vercel.json to hourly schedule</name>
  <files>vercel.json</files>
  <action>
Change cron schedule from `0 */6 * * *` (every 6 hours) to `0 * * * *` (every hour).

This enables Enterprise tier hourly scanning. The cron endpoint handles tier-specific filtering internally.
  </action>
  <verify>grep "0 \* \* \* \*" vercel.json confirms hourly schedule</verify>
  <done>Cron runs hourly at minute 0</done>
</task>

</tasks>

<verification>
- [ ] Cron endpoint imports crypto.randomInt
- [ ] Cron endpoint filters by auto_scan_enabled = true
- [ ] Hours-based calculation (not days)
- [ ] Jitter applied to scheduled_at (0-5 min range)
- [ ] vercel.json has `0 * * * *` schedule
- [ ] TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- Free tier: never queued (scanFrequencyHours = null)
- Starter tier: queued when >= 24 hours since last scan
- Professional tier: queued when >= 6 hours since last scan
- Enterprise tier: queued when >= 1 hour since last scan
- Paused brands: never queued regardless of tier
- All scan jobs: scheduled_at has 0-5 minute random jitter
</success_criteria>

<output>
After completion, create `.planning/phases/04-automated-scanning/04-02-SUMMARY.md`
</output>
