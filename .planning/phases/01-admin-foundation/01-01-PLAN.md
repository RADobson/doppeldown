---
phase: 01-admin-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260124000000_add_admin_column.sql
  - src/types/index.ts
  - src/app/api/brands/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin users can create unlimited brands"
    - "Free tier users blocked at 1 brand"
    - "Starter tier users blocked at 3 brands"
    - "Professional tier users blocked at 10 brands"
    - "Enterprise tier users have no brand limit"
  artifacts:
    - path: "supabase/migrations/20260124000000_add_admin_column.sql"
      provides: "is_admin column on users table"
      contains: "ADD COLUMN"
    - path: "src/types/index.ts"
      provides: "User interface with is_admin field"
      contains: "is_admin"
    - path: "src/app/api/brands/route.ts"
      provides: "Admin bypass and corrected tier limits"
      contains: "is_admin"
  key_links:
    - from: "src/app/api/brands/route.ts"
      to: "BRAND_LIMITS constant"
      via: "effectiveTier lookup"
      pattern: "BRAND_LIMITS\\[effectiveTier\\]"
    - from: "src/app/api/brands/route.ts"
      to: "users table"
      via: "select query with is_admin"
      pattern: "select.*is_admin"
---

<objective>
Add admin infrastructure and fix tier-based brand limits.

Purpose: Enable admin accounts to bypass all tier limits and ensure paying customers get their promised brand quota (currently broken: Starter shows 1 instead of 3).
Output: Database migration, updated TypeScript types, and corrected API route with admin bypass.
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-admin-foundation/01-RESEARCH.md

# Existing code to modify
@src/app/api/brands/route.ts
@src/types/index.ts
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration and update TypeScript types</name>
  <files>
    supabase/migrations/20260124000000_add_admin_column.sql
    src/types/index.ts
  </files>
  <action>
1. Create migrations directory if not exists: `supabase/migrations/`

2. Create migration file `supabase/migrations/20260124000000_add_admin_column.sql`:
```sql
-- Add is_admin column to users table
ALTER TABLE public.users
ADD COLUMN IF NOT EXISTS is_admin BOOLEAN DEFAULT false;

-- Add comment for documentation
COMMENT ON COLUMN public.users.is_admin IS
  'Admin users bypass all tier limits (brand count, scan quotas)';

-- Create partial index for efficient admin lookups (only indexes true values)
CREATE INDEX IF NOT EXISTS idx_users_is_admin
ON public.users(is_admin)
WHERE is_admin = true;
```

3. Update User interface in `src/types/index.ts`:
   - Add `is_admin?: boolean;` field after `customer_id` field
  </action>
  <verify>
    - Migration file exists at `supabase/migrations/20260124000000_add_admin_column.sql`
    - Migration contains `ADD COLUMN IF NOT EXISTS is_admin BOOLEAN`
    - `src/types/index.ts` User interface includes `is_admin?: boolean`
  </verify>
  <done>
    - Database migration ready to apply
    - TypeScript User type includes is_admin field
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix brand limits and add admin bypass logic</name>
  <files>
    src/app/api/brands/route.ts
  </files>
  <action>
1. Fix BRAND_LIMITS constant (lines 5-10):
```typescript
const BRAND_LIMITS: Record<string, number> = {
  free: 1,
  starter: 3,
  professional: 10,
  enterprise: Number.MAX_SAFE_INTEGER,
}
```

2. Update `getOrCreateUserRecord` function to fetch `is_admin`:
   - Change select statement from `'subscription_status, subscription_tier'`
   - To `'subscription_status, subscription_tier, is_admin'`

3. Add admin bypass in POST handler after line 124 (after `const effectiveTier = ...`):
```typescript
// Admin bypass - skip all limit checks
if (userData?.is_admin) {
  // Proceed directly to brand creation (skip brand count check)
  const body = await request.json()
  // ... rest of brand creation logic
}
```

IMPORTANT: Do NOT duplicate the entire brand creation logic. Instead, restructure:
- Check is_admin flag first
- If admin, skip the brand limit check block entirely
- Keep single brand creation code path

Simplest approach - add admin check to the limit enforcement conditional:
```typescript
// Skip limit check for admins
if (!userData?.is_admin && (existingBrands || 0) >= brandLimit) {
  // return 403 limit reached error
}
```
  </action>
  <verify>
    - `grep "starter: 3" src/app/api/brands/route.ts` returns match
    - `grep "enterprise: Number.MAX_SAFE_INTEGER" src/app/api/brands/route.ts` returns match
    - `grep "is_admin" src/app/api/brands/route.ts` returns multiple matches (select query and bypass check)
  </verify>
  <done>
    - BRAND_LIMITS matches pricing page (Free=1, Starter=3, Pro=10, Enterprise=unlimited)
    - Admin users bypass brand limit check
    - Regular users still enforced by their tier limit
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Migration file exists and is syntactically valid SQL
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. BRAND_LIMITS values match requirements: Free=1, Starter=3, Pro=10, Enterprise=MAX_SAFE_INTEGER
4. Admin bypass logic present in POST handler
</verification>

<success_criteria>
- [ ] Migration file `supabase/migrations/20260124000000_add_admin_column.sql` exists with is_admin column
- [ ] User interface in `src/types/index.ts` includes `is_admin?: boolean`
- [ ] BRAND_LIMITS in route.ts: starter=3, professional=10, enterprise=Number.MAX_SAFE_INTEGER
- [ ] Admin bypass: `!userData?.is_admin &&` guards the limit check
- [ ] TypeScript compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-admin-foundation/01-01-SUMMARY.md`
</output>
