---
phase: 13-delete-ui
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/dashboard/brands/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Swiping left on a scan row in brand detail reveals a red delete button"
    - "Swiping left on a threat row in brand detail reveals a red delete button"
    - "Tapping 3-dots menu on a scan or threat row shows a delete option"
    - "Deleting a scan removes it from the scan history list instantly"
    - "Deleting a threat removes it from the recent threats list instantly"
    - "Failed delete restores the item to its list"
  artifacts:
    - path: "src/app/dashboard/brands/[id]/page.tsx"
      provides: "Brand detail page with scan and threat delete via swipe and menu"
  key_links:
    - from: "src/app/dashboard/brands/[id]/page.tsx"
      to: "/api/scans/[id]"
      via: "fetch DELETE in handleDeleteScan"
      pattern: "fetch.*api/scans.*DELETE"
    - from: "src/app/dashboard/brands/[id]/page.tsx"
      to: "/api/threats/[id]"
      via: "fetch DELETE in handleDeleteThreat"
      pattern: "fetch.*api/threats.*DELETE"
    - from: "src/app/dashboard/brands/[id]/page.tsx"
      to: "src/components/ui/swipeable-list-item.tsx"
      via: "import SwipeableListItem"
      pattern: "import.*SwipeableListItem"
---

<objective>
Add swipe-to-delete and 3-dots kebab menu delete to the brand detail page for both scan history items and recent threat items.

Purpose: Enable users to delete individual scans and threats from the brand detail page, calling the Phase 12 DELETE endpoints with optimistic UI updates.
Output: Working delete interactions on scan history and recent threats sections of brand detail page.
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-delete-operations-backend/12-01-SUMMARY.md
@src/app/dashboard/brands/[id]/page.tsx
@src/app/dashboard/brands/page.tsx (reference for existing kebab menu pattern)
@src/components/ui/swipeable-list-item.tsx (created by 13-01, import the SwipeableListItem component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delete to scan history in brand detail page</name>
  <files>
    src/app/dashboard/brands/[id]/page.tsx
  </files>
  <action>
    Modify `src/app/dashboard/brands/[id]/page.tsx` to add delete functionality for scans:

    1. **Add imports:**
       - `{ MoreVertical, Trash2 }` from lucide-react (add to existing import)
       - `{ SwipeableListItem }` from '@/components/ui/swipeable-list-item'

    2. **Add state:**
       - `const [showScanMenu, setShowScanMenu] = useState<string | null>(null)` for scan kebab menu
       - `const [deletingScan, setDeletingScan] = useState<string | null>(null)` for scan delete loading
       - `const scanMenuRef = useRef<HTMLDivElement>(null)` for click-outside

    3. **Add click-outside handler for scan menu:**
       useEffect listening for mousedown when `showScanMenu` is set, closing menu if click outside `scanMenuRef`.

    4. **Add handleDeleteScan function:**
       Optimistic delete with rollback:
       - Set `deletingScan` to scan id
       - Backup scan object
       - Remove scan from `scans` array immediately
       - Call `fetch('/api/scans/${id}', { method: 'DELETE' })`
       - If not ok, throw error
       - On catch: restore scan (add back, sort by started_at desc), alert error
       - Finally: set `deletingScan` to null
       - On success: also call `fetchData()` to refresh threat counts (scan delete cascades threats)

    5. **Update scan history rendering (around line 810):**
       Currently each scan is rendered as:
       ```
       <div key={scan.id} className="flex items-center justify-between p-3 bg-muted rounded-lg">
       ```

       Wrap each scan item in `<SwipeableListItem onDelete={() => handleDeleteScan(scan.id)} disabled={deletingScan === scan.id}>`.

       Add a kebab menu button inline at the right side of each scan row:
       - Position a container `div ref={scanMenuRef}` with relative positioning at the right end of the scan info
       - MoreVertical button: `p-1 text-muted-foreground hover:text-foreground rounded` with `onClick` toggling `showScanMenu`
       - Stop propagation on click
       - Dropdown: `absolute right-0 mt-1 w-48 bg-card border border-border rounded-lg shadow-lg py-1 z-20`
       - Delete menu item: Trash2 icon + "Delete Scan" text, red styling with dark mode support
       - Disabled when `deletingScan === scan.id`
       - Do NOT show delete menu on running/pending scans (only completed/failed)

    6. **Important:** Do not allow deleting a scan that is currently running or pending. Check `scan.status !== 'running' && scan.status !== 'pending'` before showing the delete option.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compilation.
    Grep for `handleDeleteScan` in brands/[id]/page.tsx.
  </verify>
  <done>
    Brand detail page scan history has swipe-to-delete and 3-dots menu delete for completed/failed scans. Running scans cannot be deleted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add delete to recent threats in brand detail page</name>
  <files>
    src/app/dashboard/brands/[id]/page.tsx
  </files>
  <action>
    Continue modifying `src/app/dashboard/brands/[id]/page.tsx` to add delete for threats:

    1. **Add state (if not already added):**
       - `const [showThreatMenu, setShowThreatMenu] = useState<string | null>(null)` for threat kebab menu
       - `const [deletingThreat, setDeletingThreat] = useState<string | null>(null)` for threat delete loading
       - `const threatMenuRef = useRef<HTMLDivElement>(null)` for click-outside

    2. **Add click-outside handler for threat menu:**
       useEffect for `showThreatMenu`, same pattern as scan menu.

    3. **Add handleDeleteThreat function:**
       Optimistic delete with rollback:
       - Set `deletingThreat` to threat id
       - Backup threat object
       - Remove threat from `threats` array immediately
       - Recalculate `criticalCount`
       - Call `fetch('/api/threats/${id}', { method: 'DELETE' })`
       - If not ok, throw error
       - On catch: restore threat (add back, sort by detected_at desc), recalculate criticalCount, alert error
       - Finally: set `deletingThreat` to null

    4. **Update recent threats rendering (around line 758):**
       Currently each threat is rendered as a `<Link>` element within `divide-y divide-border`.

       Replace the `<Link>` wrapper with `<SwipeableListItem onDelete={() => handleDeleteThreat(threat.id)} disabled={deletingThreat === threat.id}>`.

       Inside SwipeableListItem, render a clickable div with `onClick={() => router.push('/dashboard/threats/${threat.id}')}` containing the existing threat content.

       Add a kebab menu at the right side of each threat row:
       - Container `div ref={threatMenuRef}` with relative positioning
       - MoreVertical button with onClick toggling `showThreatMenu`
       - Stop propagation on click
       - Dropdown with "Delete Threat" option, red styling, dark mode support
       - Disabled when `deletingThreat === threat.id`

    5. **Layout:** The threat rows currently have `flex items-center justify-between py-3 hover:bg-muted -mx-4 px-4`. Adjust to accommodate the kebab menu button between the status badge and the right edge. The menu button should appear to the right of the StatusBadge.

    6. **Build check:** Run `npx next build` to verify everything compiles.
  </action>
  <verify>
    Run `npx next build` to verify build passes.
    Grep for `handleDeleteThreat` and `handleDeleteScan` and `SwipeableListItem` in brands/[id]/page.tsx.
  </verify>
  <done>
    Brand detail page has working delete for both scans and threats. Swipe-to-delete and 3-dots menu on each item. Optimistic UI with rollback. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. Brand detail page imports SwipeableListItem
3. `handleDeleteScan` calls `fetch('/api/scans/${id}', { method: 'DELETE' })`
4. `handleDeleteThreat` calls `fetch('/api/threats/${id}', { method: 'DELETE' })`
5. Running/pending scans are excluded from delete option
6. Optimistic removal with rollback on error for both scans and threats
</verification>

<success_criteria>
- Brand detail page scan history has swipe-to-delete and 3-dots menu delete
- Brand detail page recent threats has swipe-to-delete and 3-dots menu delete
- Running scans cannot be deleted
- Optimistic UI with rollback on error
- No confirmation dialog (instant delete per project requirements)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-delete-ui/13-03-SUMMARY.md`
</output>
