---
phase: 13-delete-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/components/ui/swipeable-list-item.tsx
  - src/app/dashboard/threats/page.tsx
autonomous: true

must_haves:
  truths:
    - "Swiping left on a threat row reveals a red delete button"
    - "Tapping 3-dots menu on a threat row shows a delete option"
    - "Clicking delete removes the threat instantly from the list"
    - "Failed delete restores the threat to the list"
  artifacts:
    - path: "src/components/ui/swipeable-list-item.tsx"
      provides: "Reusable swipe-to-delete wrapper component"
      min_lines: 40
    - path: "src/app/dashboard/threats/page.tsx"
      provides: "Threats page with swipe and menu delete"
  key_links:
    - from: "src/app/dashboard/threats/page.tsx"
      to: "/api/threats/[id]"
      via: "fetch DELETE in handleDeleteThreat"
      pattern: "fetch.*api/threats.*DELETE"
    - from: "src/app/dashboard/threats/page.tsx"
      to: "src/components/ui/swipeable-list-item.tsx"
      via: "import SwipeableListItem"
      pattern: "import.*SwipeableListItem"
---

<objective>
Install react-swipeable, create a reusable SwipeableListItem component, and add swipe-to-delete + 3-dots kebab menu delete to the threats page.

Purpose: Enable users to delete threats via swipe gesture or context menu, calling the Phase 12 DELETE endpoint with optimistic UI updates.
Output: Working delete interactions on the threats list page.
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-delete-operations-backend/12-01-SUMMARY.md
@src/app/dashboard/threats/page.tsx
@src/app/dashboard/brands/page.tsx (reference for existing kebab menu pattern)
@src/components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-swipeable and create SwipeableListItem component</name>
  <files>
    package.json
    package-lock.json
    src/components/ui/swipeable-list-item.tsx
  </files>
  <action>
    1. Run `npm install react-swipeable` to add the swipe gesture library.

    2. Create `src/components/ui/swipeable-list-item.tsx` — a reusable 'use client' component:

    Props interface:
    - `children: React.ReactNode` — the list item content
    - `onDelete: () => void` — callback when delete is triggered
    - `disabled?: boolean` — prevents swipe when true (e.g., during deletion)

    Implementation:
    - Use `useSwipeable` from react-swipeable with `onSwiping` and `onSwipedLeft` handlers
    - Track `swipeOffset` state (number, negative = swiped left)
    - Only allow left swipe (negative deltaX), clamp to max -80px
    - On swipe left > 40px threshold: snap to -80px (reveal delete button). Otherwise snap back to 0.
    - Render outer `div` with `className="relative overflow-hidden"`
    - Inner content div uses `style={{ transform: translateX(${swipeOffset}px) }}` with CSS transition when not actively swiping
    - Delete button is `absolute right-0 top-0 bottom-0 w-20 bg-red-500 hover:bg-red-600 text-white flex items-center justify-center` with Trash2 icon from lucide-react
    - Clicking delete button calls `onDelete()` and resets swipeOffset to 0
    - Include `trackMouse: true` for desktop testing
    - Set `preventScrollOnSwipe: true` to avoid scroll conflicts
    - Add `aria-label="Delete"` on the delete button for accessibility
    - Reset swipeOffset to 0 when `disabled` prop changes to true (cleanup after delete)

    Export the component as a named export.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compilation passes.
    Verify react-swipeable is in package.json dependencies.
  </verify>
  <done>
    react-swipeable installed, SwipeableListItem component exists with swipe left gesture revealing delete button, accessible, reusable across all three entity pages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add swipe and kebab menu delete to threats page</name>
  <files>
    src/app/dashboard/threats/page.tsx
  </files>
  <action>
    Modify `src/app/dashboard/threats/page.tsx` to add delete functionality:

    1. **Add imports:**
       - `{ useRef }` from react
       - `{ MoreVertical, Trash2 }` from lucide-react
       - `{ SwipeableListItem }` from '@/components/ui/swipeable-list-item'

    2. **Add state:**
       - `const [showMenu, setShowMenu] = useState<string | null>(null)` for kebab menu
       - `const [deleting, setDeleting] = useState<string | null>(null)` for loading state
       - `const menuRef = useRef<HTMLDivElement>(null)` for click-outside detection

    3. **Add click-outside handler:**
       ```
       useEffect(() => {
         function handleClickOutside(event: MouseEvent) {
           if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
             setShowMenu(null)
           }
         }
         if (showMenu) {
           document.addEventListener('mousedown', handleClickOutside)
           return () => document.removeEventListener('mousedown', handleClickOutside)
         }
       }, [showMenu])
       ```

    4. **Add handleDeleteThreat function:**
       Optimistic delete with rollback pattern:
       - Set `deleting` to the threat id
       - Backup the threat object from state
       - Remove threat from `threats` array immediately (optimistic)
       - Recalculate stats (total, critical, high, new counts)
       - Call `fetch('/api/threats/${id}', { method: 'DELETE' })`
       - If response not ok, throw error
       - On catch: restore threat to state (add back and re-sort by detected_at desc), recalculate stats, show `alert('Failed to delete threat. Please try again.')`
       - Finally: set `deleting` to null

    5. **Update the threat list item rendering:**
       Change the current `<Link>` wrapper to NOT be a Link directly. Instead, wrap each threat item in `<SwipeableListItem onDelete={() => handleDeleteThreat(threat.id)} disabled={deleting === threat.id}>`.

       Inside the SwipeableListItem, render a container div that includes:
       - The existing threat content (severity badge, type label, score, brand name, URL, date) as a clickable area using `onClick={() => router.push('/dashboard/threats/${threat.id}')}` with `cursor-pointer`
       - A kebab menu (3-dots) button positioned at the right side of the row, BEFORE the status badge area

       The kebab menu pattern (adapted from brands page):
       - Wrap in a `div` with `ref={menuRef}` and relative positioning
       - MoreVertical button with `onClick` toggling `showMenu === threat.id`
       - Stop propagation on menu button click to prevent navigation
       - Dropdown: `absolute right-0 mt-1 w-48 bg-card border border-border rounded-lg shadow-lg py-1 z-20`
       - Single menu item: Delete button with Trash2 icon, red text `text-red-600 hover:bg-red-50 dark:hover:bg-red-950/30`, calls `handleDeleteThreat(threat.id)` and sets `showMenu(null)`
       - Disable delete button when `deleting === threat.id`

    6. **Important:** When the kebab menu is open for a threat, suppress swipe on that item. The menu click handler should also close the menu after triggering delete.

    7. **Dark mode:** Use `dark:hover:bg-red-950/30` for the delete menu item hover state (not `hover:bg-red-50` which is light-mode only in the brands page).
  </action>
  <verify>
    Run `npx next build` to verify build passes.
    Grep for `handleDeleteThreat` and `SwipeableListItem` in threats/page.tsx to confirm integration.
  </verify>
  <done>
    Threats page has working 3-dots menu with delete option and swipe-to-delete on each threat row. Delete calls /api/threats/[id] DELETE endpoint, optimistically removes from list, and rolls back on error.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. `src/components/ui/swipeable-list-item.tsx` exports SwipeableListItem component
3. `src/app/dashboard/threats/page.tsx` imports SwipeableListItem and has handleDeleteThreat
4. Threats page renders kebab menu with delete option per threat row
5. Delete handler calls `fetch('/api/threats/${id}', { method: 'DELETE' })`
</verification>

<success_criteria>
- react-swipeable installed in package.json
- SwipeableListItem component created and reusable
- Threats page has swipe-to-delete and 3-dots menu delete
- Optimistic UI: threat removed from list immediately, restored on error
- No confirmation dialog (instant delete per project requirements)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-delete-ui/13-01-SUMMARY.md`
</output>
