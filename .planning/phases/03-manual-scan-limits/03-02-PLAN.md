---
phase: 03-manual-scan-limits
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/dashboard/brands/[id]/page.tsx
  - src/hooks/useQuotaStatus.ts
autonomous: true

must_haves:
  truths:
    - "Free tier scan button shows 'Scan Now - 1 left this week' when quota available"
    - "Free tier scan button shows 'Upgrade to scan' when quota exhausted"
    - "Paid/admin users see normal 'Run Scan' button with no quota indicators"
    - "Upgrade CTA links to pricing page when quota exhausted"
  artifacts:
    - path: "src/hooks/useQuotaStatus.ts"
      provides: "Reusable quota status hook"
      exports: ["useQuotaStatus"]
    - path: "src/app/dashboard/brands/[id]/page.tsx"
      provides: "Updated scan button with quota display"
      contains: "useQuotaStatus"
  key_links:
    - from: "src/hooks/useQuotaStatus.ts"
      to: "/api/scan/quota"
      via: "fetch call"
      pattern: "fetch.*api/scan/quota"
    - from: "src/app/dashboard/brands/[id]/page.tsx"
      to: "src/hooks/useQuotaStatus.ts"
      via: "hook import"
      pattern: "useQuotaStatus"
---

<objective>
Update scan button UI to display quota status for Free tier users with upgrade CTA when exhausted.

Purpose: Make quota limits visible to users, provide clear upgrade path when blocked.
Output: useQuotaStatus hook, updated scan button with inline quota display.
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-manual-scan-limits/03-CONTEXT.md
@.planning/phases/03-manual-scan-limits/03-RESEARCH.md
@.planning/phases/03-manual-scan-limits/03-01-SUMMARY.md
@src/app/dashboard/brands/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useQuotaStatus hook</name>
  <files>src/hooks/useQuotaStatus.ts</files>
  <action>
Create reusable hook that fetches quota status from /api/scan/quota:

```typescript
import { useState, useEffect, useCallback } from 'react'

export interface QuotaStatus {
  limit: number | null
  used: number
  remaining: number | null
  resetsAt: number | null
  isUnlimited: boolean
}

export function useQuotaStatus() {
  const [quota, setQuota] = useState<QuotaStatus | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchQuota = useCallback(async () => {
    try {
      setLoading(true)
      const response = await fetch('/api/scan/quota')
      if (!response.ok) throw new Error('Failed to fetch quota')
      const data = await response.json()
      setQuota(data)
      setError(null)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error')
    } finally {
      setLoading(false)
    }
  }, [])

  useEffect(() => {
    fetchQuota()
  }, [fetchQuota])

  return { quota, loading, error, refetch: fetchQuota }
}
```

Include refetch function so UI can refresh quota after scan completes/fails.
  </action>
  <verify>File exists with useQuotaStatus export</verify>
  <done>Hook created with quota, loading, error, refetch returns</done>
</task>

<task type="auto">
  <name>Task 2: Update brand detail page scan button with quota display</name>
  <files>src/app/dashboard/brands/[id]/page.tsx</files>
  <action>
1. Import useQuotaStatus hook at top of file
2. Call hook in component: `const { quota, loading: quotaLoading, refetch: refetchQuota } = useQuotaStatus()`
3. After successful scan (in handleScan success path) and after scan completion (in poll success), call `refetchQuota()`

4. Update scan button rendering logic:

**Header "Run Scan" button:**
```tsx
<Button
  variant="outline"
  onClick={handleScan}
  disabled={scanning || (quota && !quota.isUnlimited && quota.remaining === 0)}
>
  {scanning ? (
    <>
      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
      Scanning...
    </>
  ) : quota && !quota.isUnlimited && quota.remaining === 0 ? (
    <>Upgrade to scan</>
  ) : quota && !quota.isUnlimited ? (
    <>
      <Play className="h-4 w-4 mr-2" />
      Scan Now · {quota.remaining} left this week
    </>
  ) : (
    <>
      <Play className="h-4 w-4 mr-2" />
      Run Scan
    </>
  )}
</Button>
```

5. Add upgrade CTA banner when quota exhausted (above the scan button):
```tsx
{quota && !quota.isUnlimited && quota.remaining === 0 && (
  <div className="rounded-lg border border-blue-100 bg-blue-50 p-4 mb-4">
    <div className="flex items-start gap-3">
      <div className="p-2 bg-blue-100 rounded-lg">
        <AlertCircle className="h-5 w-5 text-blue-600" />
      </div>
      <div className="flex-1">
        <h3 className="font-semibold text-blue-900 mb-1">
          You've used your free scan this week
        </h3>
        <p className="text-sm text-blue-800 mb-3">
          Upgrade for unlimited manual scans, automated monitoring, and more.
        </p>
        <Link href="/pricing">
          <Button size="sm">View plans</Button>
        </Link>
      </div>
    </div>
  </div>
)}
```

6. Import AlertCircle from lucide-react if not already imported

7. Update Quick Actions "Run Full Scan" button with same disabled logic and text
  </action>
  <verify>
Visual check:
- Free tier with remaining quota: Button shows "Scan Now · 1 left this week"
- Free tier exhausted: Button disabled, shows "Upgrade to scan", upgrade CTA banner visible
- Paid/admin: Normal "Run Scan" button, no quota indicators
  </verify>
  <done>
- Scan buttons show quota inline for Free tier
- Disabled + upgrade CTA when exhausted
- Paid/admin see standard buttons
- Quota refetches after scan operations
  </done>
</task>

</tasks>

<verification>
1. Free tier user with 1 remaining scan sees "Scan Now · 1 left this week"
2. After scanning, button shows "Upgrade to scan" + blue upgrade CTA banner
3. Clicking upgrade CTA goes to /pricing
4. Paid tier user sees "Run Scan" with no quota text
5. Admin user sees "Run Scan" with no quota text
6. Quota status updates after scan completes (no stale state)
</verification>

<success_criteria>
- useQuotaStatus hook exports and fetches from /api/scan/quota
- Free tier scan button shows remaining count or "Upgrade to scan"
- Upgrade CTA banner appears when quota exhausted
- Paid/admin users see no quota indicators
- Button disabled state prevents click when exhausted
</success_criteria>

<output>
After completion, create `.planning/phases/03-manual-scan-limits/03-02-SUMMARY.md`
</output>
