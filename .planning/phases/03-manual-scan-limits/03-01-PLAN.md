---
phase: 03-manual-scan-limits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260127100001_add_manual_scan_quota.sql
  - src/app/api/scan/route.ts
  - src/app/api/scan/quota/route.ts
  - src/lib/tier-limits.ts
autonomous: true

must_haves:
  truths:
    - "Free tier users blocked from scanning when quota exhausted (1 per week)"
    - "Paid tier users can scan unlimited times"
    - "Admin users bypass all quota checks"
    - "Quota resets automatically after 7 days from first scan"
  artifacts:
    - path: "supabase/migrations/20260127100001_add_manual_scan_quota.sql"
      provides: "manual_scans_period_start and manual_scans_count columns"
      contains: "manual_scans_period_start"
    - path: "src/app/api/scan/route.ts"
      provides: "Quota enforcement before scan creation"
      contains: "manual_scans_count"
    - path: "src/app/api/scan/quota/route.ts"
      provides: "Quota status endpoint"
      exports: ["GET"]
    - path: "src/lib/tier-limits.ts"
      provides: "getManualScanLimit function"
      contains: "getManualScanLimit"
  key_links:
    - from: "src/app/api/scan/route.ts"
      to: "users table"
      via: "quota check before scan insert"
      pattern: "manual_scans_period_start"
    - from: "src/app/api/scan/quota/route.ts"
      to: "users table"
      via: "quota status query"
      pattern: "manual_scans_count"
---

<objective>
Add database schema and API enforcement for tier-based manual scan quotas.

Purpose: Block Free tier users from unlimited manual scans, driving upgrades. Paid tiers remain unlimited.
Output: Migration file, updated scan API with quota enforcement, new quota status endpoint.
</objective>

<execution_context>
@/home/dobsondev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dobsondev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-manual-scan-limits/03-CONTEXT.md
@.planning/phases/03-manual-scan-limits/03-RESEARCH.md
@src/lib/tier-limits.ts
@src/app/api/scan/route.ts
@src/app/api/brands/route.ts (for admin bypass pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quota tracking columns to users table</name>
  <files>supabase/migrations/20260127100001_add_manual_scan_quota.sql</files>
  <action>
Create migration adding two columns to users table:
- `manual_scans_period_start TIMESTAMP WITH TIME ZONE` - first scan timestamp of current period (NULL = no scans yet)
- `manual_scans_count INTEGER DEFAULT 0` - cached count of scans in current period

Add partial index on manual_scans_period_start for non-null values (similar to is_admin index pattern from 01-01).

SQL pattern:
```sql
ALTER TABLE users
ADD COLUMN manual_scans_period_start TIMESTAMP WITH TIME ZONE,
ADD COLUMN manual_scans_count INTEGER DEFAULT 0;

CREATE INDEX idx_users_manual_scan_period
ON users(manual_scans_period_start)
WHERE manual_scans_period_start IS NOT NULL;
```
  </action>
  <verify>File exists with correct ALTER TABLE and CREATE INDEX statements</verify>
  <done>Migration file created with manual_scans_period_start and manual_scans_count columns</done>
</task>

<task type="auto">
  <name>Task 2: Add quota helper function to tier-limits.ts</name>
  <files>src/lib/tier-limits.ts</files>
  <action>
Add `getManualScanLimit(tier: string): number | null` function that returns:
- `null` for 'starter', 'professional', 'enterprise' (unlimited)
- `1` for 'free' tier

This follows the existing pattern of getTierLimits, getEffectiveTier, getBrandLimit.

Also add MANUAL_SCAN_PERIOD_MS constant: `604800000` (7 days in milliseconds).
  </action>
  <verify>grep -q "getManualScanLimit" src/lib/tier-limits.ts</verify>
  <done>getManualScanLimit function returns 1 for free tier, null for paid tiers</done>
</task>

<task type="auto">
  <name>Task 3: Add quota enforcement to scan API and create quota endpoint</name>
  <files>src/app/api/scan/route.ts, src/app/api/scan/quota/route.ts</files>
  <action>
**In /api/scan/route.ts POST handler:**

1. Update user query to include `is_admin, manual_scans_period_start, manual_scans_count`
2. After fetching userData, before checking for existing jobs, add quota enforcement:

```typescript
import { getManualScanLimit, MANUAL_SCAN_PERIOD_MS } from '@/lib/tier-limits'

// Admin bypass (Phase 1 pattern)
const manualScanLimit = getManualScanLimit(effectiveTier)
if (!userData?.is_admin && manualScanLimit !== null) {
  const now = new Date()
  const periodStart = userData?.manual_scans_period_start

  // Check if period expired (7 days)
  const periodExpired = !periodStart ||
    (now.getTime() - new Date(periodStart).getTime() > MANUAL_SCAN_PERIOD_MS)

  if (periodExpired) {
    // Reset period atomically with first scan of new period
    await supabase
      .from('users')
      .update({
        manual_scans_period_start: now.toISOString(),
        manual_scans_count: 1  // Count this scan
      })
      .eq('id', user.id)
  } else {
    // Check quota
    const scansUsed = userData?.manual_scans_count || 0
    if (scansUsed >= manualScanLimit) {
      const resetsAt = new Date(periodStart).getTime() + MANUAL_SCAN_PERIOD_MS
      return NextResponse.json(
        {
          error: 'Manual scan quota exceeded',
          code: 'QUOTA_EXCEEDED',
          quota: { limit: manualScanLimit, used: scansUsed, resetsAt }
        },
        { status: 429 }
      )
    }
    // Increment count
    await supabase
      .from('users')
      .update({ manual_scans_count: scansUsed + 1 })
      .eq('id', user.id)
  }
}
```

**Create /api/scan/quota/route.ts:**

GET endpoint returning quota status for current user:
```typescript
interface QuotaResponse {
  limit: number | null  // null = unlimited
  used: number
  remaining: number | null  // null = unlimited
  resetsAt: number | null  // timestamp ms, null if unlimited or period not started
  isUnlimited: boolean
}
```

Logic:
1. Get user auth
2. Fetch user subscription_status, subscription_tier, is_admin, manual_scans_period_start, manual_scans_count
3. If admin or paid tier: return isUnlimited: true
4. If free tier: calculate remaining quota based on period, handle expired period (returns full quota)
  </action>
  <verify>
curl commands work (after migration applied):
- POST /api/scan with Free tier user returns 429 after 1 scan
- GET /api/scan/quota returns correct quota status
  </verify>
  <done>
- Free tier blocked at 1 scan/week with 429 + quota info
- Paid/admin users bypass quota check
- GET /api/scan/quota returns remaining quota status
  </done>
</task>

</tasks>

<verification>
After `supabase db push`:
1. Check users table has new columns: `manual_scans_period_start`, `manual_scans_count`
2. Free tier user: First scan succeeds, second scan returns 429 with quota info
3. Paid tier user: Multiple scans succeed without limit
4. Admin user: Scans succeed regardless of tier
5. GET /api/scan/quota returns accurate quota status
</verification>

<success_criteria>
- Migration file exists and applies cleanly
- Free tier users limited to 1 manual scan per 7-day rolling window
- 429 response includes `code: 'QUOTA_EXCEEDED'` and `quota` object with limit/used/resetsAt
- Paid/admin users bypass quota enforcement
- Quota endpoint returns accurate remaining count
</success_criteria>

<output>
After completion, create `.planning/phases/03-manual-scan-limits/03-01-SUMMARY.md`
</output>
