# Milestone v1.3: Delete Operations with Audit Logging

**Status:** ✅ SHIPPED 2026-01-29
**Phases:** 11-13
**Total Plans:** 5

## Overview

Enable users to delete scans, threats, and reports with full accountability via audit logging. Adds audit_logs infrastructure, DELETE API endpoints with RLS policies, and swipe-to-delete/kebab menu UI across all dashboard pages.

## Phases

### Phase 11: Audit Logging Infrastructure

**Goal**: Accountability trail for all delete actions
**Depends on**: Phase 10
**Plans**: 1 plan

Plans:
- [x] 11-01: Audit logging table, service function, and admin query endpoint

**Details:**
- Created `audit_logs` table with user_id (ON DELETE SET NULL), action, entity_type, entity_id, metadata, timestamps
- Admin-only RLS policies (EXISTS subquery checking `public.users.is_admin = TRUE`)
- `logAudit()` best-effort service function using service role client (catches errors, never throws)
- `GET /api/admin/audit-logs` with pagination and entity_type/user_id filters
- TypeScript types: AuditLog, AuditAction, AuditEntityType

### Phase 12: Delete Operations Backend

**Goal**: Users can delete scans, threats, and reports via API
**Depends on**: Phase 11
**Plans**: 1 plan

Plans:
- [x] 12-01: DELETE RLS policies and API endpoints for scans, threats, reports

**Details:**
- RLS DELETE policies for threats, scans, reports tables (ownership via brands join)
- `DELETE /api/scans/[id]` — auth, ownership, manual threat cascade, storage cleanup, audit log
- `DELETE /api/threats/[id]` — auth, ownership, storage cleanup, audit log
- `DELETE /api/reports/[id]` — auth, ownership, audit log
- Returns 404 for unauthorized (prevents resource enumeration)
- Best-effort storage cleanup (orphaned files acceptable)

### Phase 13: Delete UI

**Goal**: Intuitive delete gestures available in dashboard
**Depends on**: Phase 12
**Plans**: 3 plans

Plans:
- [x] 13-01: Install react-swipeable, create SwipeableListItem component, add delete to threats page
- [x] 13-02: Add swipe and menu delete to reports page
- [x] 13-03: Add swipe and menu delete to brand detail page (scans + threats)

**Details:**
- Reusable `SwipeableListItem` component (left swipe, 40px threshold, -80px reveal)
- Optimistic delete with rollback on error across all pages
- Kebab menu (3-dots) with click-outside detection
- Running/pending scan protection (cannot delete active scans)
- Dark mode support for menu hover states
- Desktop testing support via `trackMouse: true`

---

## Milestone Summary

**Key Decisions:**
- audit_logs.user_id uses ON DELETE SET NULL — audit records survive user deletion
- logAudit() best-effort pattern — catches errors, never throws
- Service role for writes, user client for reads
- Return 404 (not 403) for unauthorized deletes — prevents resource enumeration
- Manual threat cascade before scan deletion — FK is SET NULL not CASCADE
- Best-effort storage cleanup — orphaned files acceptable
- 40px swipe threshold — balances accidental vs deliberate gestures
- Optimistic delete with rollback — instant feedback for responsive UX
- Left swipe only — consistent with iOS/Android patterns
- No confirmation dialog — instant delete per user request

**Issues Resolved:**
- Supabase TypeScript type inference for inner joins (explicit type casts needed)
- Next.js 14+ params as Promise pattern in App Router DELETE handlers
- Click-outside detection for kebab menus using useRef + mousedown

**Issues Deferred:**
- Automated test coverage (0% across all phases) — manual testing only
- Toast notifications for error feedback (currently uses alert())
- Undo/undo-toast after successful delete
- Individual audit entries for cascade-deleted threats (only scan audit includes cascade count)

**Technical Debt Incurred:**
- No automated test coverage for delete endpoints or UI
- Storage cleanup is best-effort — orphaned files possible
- Uses alert() for error feedback instead of toast notifications
- No undo after successful delete

---

_For current project status, see .planning/ROADMAP.md_
